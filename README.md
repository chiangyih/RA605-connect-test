# RA605-connect-test2

## 概覽
`RA605-connect-test2` 是一個 WinForms 用戶端應用程式，用來測試和控制 HIWIN RA605 機械手臂。透過 HRSDK（Hiwin Robot SDK）的 `HRobot.dll`，應用程式可以實現連線、馬達控制、位置查詢和 LIN 直線運動等功能。工程師無需進入示教器就能驗證通訊協議、運動軌跡和安全邏輯。

## 主要功能

### 1. 連線管理
- **預設 IP**：`192.168.203.200`（可自訂）
- **連線驗證**：自動顯示 SDK 版本及連線狀態
- **錯誤診斷**：詳細的連線失敗原因提示（網路、回呼機制、版本不符等）
- **安全斷開**：應用程式結束或按下結束按鈕時自動斷開連接

### 2. 馬達控制
- **馬達開啟 (Motor ON)**
  - 檢查目前馬達狀態
  - 若已開啟則提示用戶
  - 若開啟失敗會自動檢查警報代碼並提示原因
  
- **馬達關閉 (Motor OFF)**
  - 要求用戶確認（防止誤操作）
  - 關閉後驗證狀態變更
  - 若失敗會提示可能的原因（安全門、警報、狀態不正確）

- **狀態確認機制**
  - 發送命令後等待 500ms 再次檢查狀態
  - 若狀態未變更會顯示警告並檢查警報
  - 所有操作都會在日誌中記錄

### 3. 位置管理
- **取得當前位置 (Get Current Position)**
  - 一鍵查詢機械手臂即時座標（X, Y, Z, A, B, C）
  - 同時取得六個關節的角度（J1~J6）
  - 自動填入 LIN 運動測試的輸入框
  - 方便進行增量調整和預測性測試

### 4. LIN 直線運動測試
完整的運動流程包括：

#### 輸入驗證
- 座標輸入（X, Y, Z, A, B, C）必須為有效數字
- 速度輸入必須 > 0（mm/s）
- 運動模式和平滑值可選

#### 前置檢查
1. **馬達狀態檢查** - 確保馬達已開啟
2. **操作模式檢查** - 驗證手臂在自動模式（若不是會嘗試自動切換）
3. **運動狀態查詢** - 記錄目前的運動狀態
4. **可達性檢查** - 驗證目標點在工作範圍內且不會產生奇異點
5. **路徑檢查** - 驗證從目前位置到目標位置的直線路徑無障礙

#### 命令執行
- 先設定速度（mm/s）
- 執行 `lin_pos` 絕對座標運動
- 若命令失敗會自動檢查警報代碼

#### 完成等待
- 監控命令佇列直到為空
- 等效於示教器上「到點後才下一行」的效果
- 每 100ms 檢查一次佇列狀態

### 5. 日誌系統
- **時間戳記** - 每則訊息都帶有 HH:mm:ss.fff 格式的精確時間
- **多執行緒安全** - SDK 回呼函式的日誌透過 `BeginInvoke` 確保執行緒安全
- **診斷信息** - 包括返回碼、狀態值和警報代碼等詳細資訊
- **可滾動視窗** - 支援將日誌匯出以協助除錯

## 技術架構

### 代碼組織
應用程式使用 `#region` 進行邏輯分區：

| 區域 | 功能 |
|------|------|
| **Constants** | 所有常數定義（狀態碼、延遲時間等） |
| **Fields** | 私有欄位（機械手臂 ID、連線狀態） |
| **Connection Management** | 連線、斷開、SDK 版本查詢 |
| **Motor Control** | 馬達開關、狀態檢查、警報回報 |
| **Position Management** | 位置查詢、座標載入 |
| **LIN Motion** | 運動驗證、執行和完成等待 |
| **Helper Methods** | 日誌、參數讀取等輔助函式 |

### 設計原則
- **常數化** - 所有魔數都提取為命名常數便於維護
- **方法分解** - 大型方法拆分為單一職責的小方法
- **錯誤處理** - 統一的異常處理和用戶提示
- **執行緒安全** - 使用 `volatile` 和 `BeginInvoke` 確保多執行緒安全

## 使用需求

### 軟體環境
- **.NET 版本** - .NET 10
- **開發環境** - Visual Studio 2022 或更新版本（啟用 Windows Forms 工作負載）
- **Windows 版本** - Windows 7 或更新

### 硬體和外部依賴
- **HRSDK** - 需安裝 Hiwin Robot SDK
- **SDK 程式庫** - `HRSDK.dll` 必須在可執行檔旁或在 PATH 中
- **網路** - 能透過設定的 IP 位址存取手臂控制器
- **手臂控制器** - HIWIN RA605 或相容型號

## 建置步驟

### 1. 環境準備
```bash
# 確保已安裝 .NET 10 SDK
dotnet --version

# 確保已安裝 Visual Studio 2022
# 並啟用 Windows Forms 工作負載
```

### 2. 開啟專案
```bash
# 使用 Visual Studio 開啟
start RA605-connect-test2.csproj

# 或使用 Visual Studio Code
code .
```

### 3. 建置應用程式
```bash
# 在 Visual Studio 中：
# 選單 → Build → Build Solution（或按 Ctrl+Shift+B）

# 或在命令列中：
dotnet build
```

### 4. 配置 HRSDK
- 將 `HRSDK.dll` 複製到輸出目錄（`bin/Debug/net10.0-windows/` 或 `bin/Release/net10.0-windows/`）
- 或確保 HRSDK 的安裝路徑已加入系統 PATH

## 執行說明

### 步驟 1：啟動應用程式
```bash
# 在 Visual Studio 中按 F5（Debug）或 Ctrl+F5（Release）
# 或直接執行輸出的 .exe 檔案
```

### 步驟 2：連接手臂
1. 確認預設 IP `192.168.203.200` 正確（如需修改在文字框中變更）
2. 點擊 **`Connect`** 按鈕
3. 觀察日誌視窗確認連接成功（會顯示 SDK 版本和 robotId）

### 步驟 3：開啟馬達
1. 點擊 **`Motor ON`** 按鈕
2. 等待確認訊息表示馬達已成功開啟
3. 如果失敗，查看日誌和警報提示來解決問題

### 步驟 4：查詢當前位置（可選）
1. 點擊 **`Get Current Position`** 按鈕
2. 座標和關節角度會自動填入 LIN 輸入框
3. 可以基於目前位置進行微調

### 步驟 5：執行 LIN 直線運動
1. 設定目標座標（X, Y, Z, A, B, C）
2. 設定速度（mm/s，必須 > 0）
3. 可選：設定運動模式和平滑值
4. 點擊 **`Execute LIN`** 按鈕
5. 觀察日誌視窗，會依序進行：
   - 馬達狀態檢查
   - 操作模式檢查
   - 可達性檢查
   - 路徑檢查
   - 命令執行
   - 完成等待（監控佇列清空）

### 步驟 6：關閉馬達
1. 點擊 **`Motor OFF`** 按鈕
2. 確認提示訊息後馬達關閉
3. 所有運動停止

### 步驟 7：結束應用程式
1. 點擊 **`Exit`** 按鈕
2. 若已連接會自動斷開連接
3. 應用程式結束

## 故障排除

### 連接失敗
| 錯誤代碼 | 原因 | 解決方案 |
|---------|------|--------|
| -1 | 命令/連接失敗 | 檢查 IP 位址是否正確、網路連接 |
| -2 | 回呼機制建立失敗 | 重啟應用程式或檢查系統資源 |
| -3 | 無法連接到手臂 | 檢查 IP、網路、手臂是否開機 |
| -4 | SDK 版本不符 | 更新 HRSDK 到相容版本 |

### 馬達無法開啟
- 檢查日誌中是否有警報（顯示為 `Alarm[n]: 0x...`）
- 在示教器上清除警報後重試
- 確認安全門已關閉
- 驗證操作模式是否正確

### LIN 命令執行失敗
- 檢查目標座標是否在工作範圍內
- 查看日誌中的可達性和路徑檢查結果
- 驗證速度參數有效（> 0）
- 檢查是否存在關節限制或奇異點

### 日誌異常或無回應
- 檢查 HRSDK.dll 是否正確加載
- 嘗試重新連接
- 查看 Windows 事件檢視器的錯誤訊息
- 確認網路連接穩定

## 日誌和診斷

### 日誌格式
```
HH:mm:ss.fff [Message]
```

### 典型的成功流程日誌
```
17:03:45.123 HRSDK Version: 1.2.3
17:03:46.456 Connecting to 192.168.203.200 ...
17:03:47.789 Connect OK. robotId=0
17:03:48.012 Turning motor ON...
17:03:48.234 Current motor state: 0 (1=ON, 0=OFF)
17:03:48.456 Motor ON command: rc=0
17:03:48.967 New motor state: 1 (1=ON, 0=OFF)
17:03:49.123 Motor ON confirmed.
```

### 故障日誌範例
```
17:10:30.456 Motor state: 0 (1=ON, 0=OFF)
17:10:30.567 Target reachability check: rc=0, reachable=false
17:10:31.123 Active alarms detected: 1
17:10:31.234   Alarm[0]: 0x0001
```

### 如
